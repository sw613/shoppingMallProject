<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" xmlns:sec="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>HAPPY SHOP</title>
    <link rel="stylesheet" href="/css/review-star.css">
    <link rel="stylesheet" href="/css/comment-style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css">
<body>

<div th:insert="~{fragment/header :: header}"></div>

<main>
    <!--  상품 설명  -->
    <section class="container pt-5">
        <div class="row">

            <!-- 상품 사진 -->
            <div class="col w-50">
                <img id="product-reqImage" class="rounded w-75" src="/sample_img.jpg" th:src="${product.reqImage}">
            </div>

			<!-- 상품 정보 -->
			<div class="col w-50">
			    <div class="row">
					  <div class="icon-viewcount">
					      <img class="eye-icon" src="/img/eye.png">
					      <span class="viewcount" th:text="${product.viewCount}"></span>
					  </div>
			        <h3 id="productName" th:text="${product.title}">Product Title</h3>
			        <h6 class="product-detail-font" th:text="${product.detail}">상품 간단 설명</h6>
			    </div>
			    <div class="row">
			        <p id="productBasicPrice" th:attr="data-basic-price=${product.price}"
			           th:text="${#numbers.formatInteger(product.price, 3, 'COMMA') + ' 원'}">price</p>
			    </div>
			    <!-- 옵션선택 -->
			    <div class="row">
			        <select class="form-select option-select" aria-label="Default select example">
			            <option selected>[필수] 옵션을 선택해 주세요</option>
			            <option th:value="${option.id}"
			                    th:each="option , iterStat : ${options}"
			                    th:data-price="${option.getOptionPrice()}"
			    				th:text="${option.optionName + ' │ (' + option.optionCount + '개 남음)'}"
                                th:attr="data-option-count=${option.optionCount}"
			    				th:disabled="${option.optionCount == 0}">
			                옵션명
			            </option>
			        </select>
			    </div>
                <!-- 선택된 옵션 표시 -->
                <div class="row pt-4 " id="selectedProductDiv">

                </div>

                <!-- 총 가격 -->
                <div class="row pt-4">
                    <p class="col">TOTAL PRICE</p>
                    <p id="totalPrice" class="col">0 원</p>
                </div>
                <!-- 버튼 -->
                <div class="row w-50 pt-2 gap-2">
                    <button id="addToCartBtn" th:data-product-id="${product.id}" class="col btn btn-light">장바구니</button>
                    <button id="buyBtn" th:attr="data-product-id=${product.id}" class="col custom-btn custom-btn-primary">구매하기</button>
                </div>
            </div>

        </div>
    </section>

    <!-- details, reviews, Q&A  -->
    <section class="container pt-5 pb-5">
        <!-- 네비게이션 탭  -->
        <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab"
                        data-bs-toggle="tab" data-bs-target="#home-tab-pane"
                        type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">DETAILS
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane"
                        type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">REVIEWS
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact-tab-pane"
                        type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">Q&A
                </button>
            </li>
        </ul>
        <!-- 탭 내용 -->
        <div class="tab-content" id="myTabContent">

            <!--  상품 디테일  -->
            <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab"
                 tabindex="0">
                <div class="pt-3">
                    <div class="d-flex justify-content-center align-items-center" th:each="productImg : ${productImgs}">
                        <img src="" th:src="${productImg.url}">
                    </div>
                </div>

            </div>

            <!--  리뷰 -->
            <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
                <div class="container pt-3">

                    <h1>REVIEW LIST</h1>

                    <div class="">

                        <!-- 리뷰 카드 -->
                        <div th:if="${reviews.size()} == 0">
                            <div class="d-flex align-items-center justify-content-center bg-body-secondary empty-data-back">
                                <span>아직 작성된 리뷰가 없습니다.</span>
                            </div>
                        </div>
                        <div class="card row" th:each="review : ${reviews}">
                            <div class="card-body container">
                                <div class="row align-items-center">
                                    <div class="col-auto">

                                        <!-- 별점 자리 -->
                                        <div class="rating-display">
                                            <!-- 채워진 별 -->
                                            <span class="star full"
                                                  th:each="i : ${#numbers.sequence(1, T(java.lang.Math).floor(review.score), 1)}">★</span>

                                            <!-- 반쪽 별 -->
                                            <span class="star half" th:if="${review.score % 1 >= 0.5}">☆</span>

                                            <!-- 빈 별 -->
                                            <span class="star"
                                                  th:each="i : ${#numbers.sequence(1, 5 - T(java.lang.Math).ceil(review.score), 1)}">☆</span>
                                        </div>
                                    </div>
                                    <div class="col-auto" th:text="${review.username}">닉네임</div>
                                    <div class="col-auto" th:text="${#temporals.format(review.atCreate, 'yy-MM-dd')}">구매
                                        날짜
                                    </div>
                                    <div class="col" sec:authorize="isAuthenticated()"
                                         th:if="${review.getUsersId() == user.getId()}">
                                        <button type="button"
                                                class="custom-btn  custom-btn-primary edit-review-btn"
                                                id="edit-review-button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#reviewModal"
                                                th:attr="data-review-id=${review.id}, data-review-content=${review.detail}, data-review-score=${review.score}, data-product-id=${product.id}">
                                            수정
                                        </button>
                                        <button type="button"
                                                class="btn  btn-secondary delete-review-btn"
                                                th:attr="data-review-id=${review.id}">
                                            삭제
                                        </button>
                                    </div>
                                </div>
                                <div class="row">
                                    <h5 class="card-title ellipsis" th:text="${review.detail}">Card title</h5>
                                </div>
                                <div class="row">
                                    <p class="card-text" th:text="${review.detail}" style="white-space: pre-line;">
                                        detail </p>
                                </div>
                            </div>
                        </div>


                    </div>

                    <!-- 리뷰 페이지네이션 -->
                    <div class="pt-2 d-flex align-items-center justify-content-center">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination">
                                <li class="page-item">
                                    <a class="page-link" href="#"
                                       th:href="@{/product/{id}(id=${product.id}, reviewPage=1)}"
                                       aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item" th:each="page : ${#numbers.sequence(1,reviewTotalPages, 1)}">
                                    <a class="page-link" th:text="${page}"
                                       th:href="@{/product/{id}(id=${product.id}, reviewPage=${page})}" href="#">1</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#"
                                       th:href="@{/product/{id}(id=${product.id}, reviewPage=${reviewTotalPages})}"
                                       aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <!-- 리뷰 작성 버튼 -->
                    <div class="">
                        <!-- 버튼 -->
                        <button type="button" id="show-reviewModal-btn" class="custom-btn custom-btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#reviewModal"
                                th:attr="data-product-id=${product.id}"
                                th:if="${isConsumer && !isReviewer}">
                            리뷰 작성하기
                        </button>

                        <!-- 리뷰 작성 모달 -->
                        <div class="modal fade" id="reviewModal" data-bs-backdrop="static" data-bs-keyboard="false"
                             tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="reviewModalLabel">리뷰 작성</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="reviewForm">
                                            <input type="hidden" name="productId" id="review-productId">
                                            <div>
                                                <label for="review-detail">내용</label>
                                                <textarea class="form-control" name="detail" id="review-detail"
                                                          type="text" rows="8" cols="30" maxlength="255"
                                                          placeholder="10글자 이상 입력해주세요."></textarea>
                                            </div>
                                            <div class="pt-2">
                                                <label>평점</label>
                                            </div>
                                            <fieldset class="rate">
                                                <input type="radio" id="score10" name="score" value="10"><label
                                                    for="score10" title="5점"></label>
                                                <input type="radio" id="score9" name="score" value="9"><label
                                                    class="half" for="score9" title="4.5점"></label>
                                                <input type="radio" id="score8" name="score" value="8"><label
                                                    for="score8" title="4점"></label>
                                                <input type="radio" id="score7" name="score" value="7"><label
                                                    class="half" for="score7" title="3.5점"></label>
                                                <input type="radio" id="score6" name="score" value="6"><label
                                                    for="score6" title="3점"></label>
                                                <input type="radio" id="score5" name="score" value="5"><label
                                                    class="half" for="score5" title="2.5점"></label>
                                                <input type="radio" id="score4" name="score" value="4"><label
                                                    for="score4" title="2점"></label>
                                                <input type="radio" id="score3" name="score" value="3"><label
                                                    class="half" for="score3" title="1.5점"></label>
                                                <input type="radio" id="score2" name="score" value="2"><label
                                                    for="score2" title="1점"></label>
                                                <input type="radio" id="score1" name="score" value="1"><label
                                                    class="half" for="score1" title="0.5점"></label>
                                            </fieldset>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소
                                        </button>
                                        <button type="button" class="custom-btn custom-btn-primary" id="submitReview"
                                                disabled>작성완료
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!--  Q&A  -->
            <div class="tab-pane fade" id="contact-tab-pane" role="tabpanel" aria-labelledby="contact-tab" tabindex="0">
                <div class="container pt-3">

                    <h1>Q&A</h1>

                    <!-- Q&A 게시판 -->
                    <div class="container-fluid border-dark border-top border-bottom border-2">
                        <!-- 헤더 -->
                        <div class="row align-items-center border-bottom py-2 text-center">
                            <div style="width: 10%;"><span>답변상태</span></div>
                            <div style="width: 60%; text-align: left;"><span>제목</span></div>
                            <div style="width: 15%;"><span>작성자</span></div>
                            <div style="width: 15%;"><span>작성일</span></div>
                        </div>

                        <!-- 질문 및 답변 -->
                        <div th:if="${comments.size()} == 0">
                            <div class="d-flex align-items-center justify-content-center bg-body-secondary empty-data-back">
                                <span>아직 작성된 문의가 없습니다.</span>
                            </div>
                        </div>
                        <div class="row border-bottom" th:each="comment : ${comments}">
                            <!-- 질문 -->
                            <div class="w-100 row py-2 align-items-center">
                                <div style="width: 10%; text-align: center;">
                                    <span th:text="${comment.recomment} == null ? '미답변' : '답변완료'">미답변</span>
                                </div>
                                <div style="width: 60%;">
                                    <button th:if="${user != null and (comment.isSecret() == false or comment.userId == user.id or #authorization.expression('hasRole(''ADMIN'')'))}"
                                            class="col btn btn-light toggle-answer-btn w-100" type="button"
                                            style="border: none; background: none;">
                                        <span style="text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 100%;"
                                              th:text="${comment.detail.trim()}">질문</span>
                                    </button>
                                    <!-- 비밀글 -->
                                    <span th:if="${user == null || (comment.isSecret() and comment.userId != user.id and !#authorization.expression('hasRole(''ADMIN'')'))}"
                                          class="text-muted">
                                        비밀글입니다.
                                    </span>
                                    <!-- 문의 수정, 문의 삭제, 답글 작성, 답글 수정 버튼 -->
                                    <div class="col" sec:authorize="isAuthenticated()">
                                        <button type="button"
                                                class="custom-btn  custom-btn-primary edit-comment-btn"
                                                id="edit-comment-button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#commentModal"
                                                th:attr="data-comment-id=${comment.id}, data-comment-content=${comment.detail}, data-comment-isSecret=${comment.isSecret()}, data-product-id=${product.id}"
                                                th:if="${comment.getUserId() == user.getId()}">
                                            수정
                                        </button>
                                        <button type="button"
                                                class="btn  btn-secondary delete-comment-btn"
                                                th:attr="data-comment-id=${comment.id}"
                                                th:if="${comment.getUserId() == user.getId()}">
                                            삭제
                                        </button>

                                        <button type="button"
                                                id="show-recommentModal-btn"
                                                class="custom-btn  custom-btn-primary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#recommentModal"
                                                th:attr="data-comment-id=${comment.id}, data-product-id=${product.id}"
                                                th:if="${comment.recomment == null}"
                                                sec:authorize="hasRole('ROLE_ADMIN')">
                                            답글 작성
                                        </button>

                                        <button type="button"
                                                id="edit-recomment-button"
                                                class="custom-btn  custom-btn-primary edit-recomment-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#recommentModal"
                                                th:if="${comment.recomment} != null"
                                                sec:authorize="hasRole('ROLE_ADMIN')"
                                                th:attr="data-comment-id=${comment.id}, data-product-id=${product.id}, data-recomment-id=${comment.recomment.id}, data-recomment-content=${comment.recomment.detail}">
                                            답글 수정
                                        </button>
                                    </div>
                                </div>
                                <div class="text-center" style="width: 15%;"><span
                                        th:text="${comment.username}">닉네임</span></div>
                                <div class="text-center" style="width: 15%;"><span
                                        th:text="${#temporals.format(comment.atCreate, 'yy-MM-dd')}">YY.MM.DD</span>
                                </div>
                            </div>

                            <!-- 답변 (숨김 처리) -->
                            <div class="w-100 row answer-row" th:if="${comment.recomment} != null"
                                 style="display: none;">
                                <!-- 답변 질문 -->
                                <div class="row py-2">
                                    <div style="width: 10%;"><span></span></div>
                                    <div style="width: 90%;" class="border-top pt-2">
                                        <span th:text="${comment.detail}" style="white-space: pre-line;">질문</span>
                                    </div>
                                </div>
                                <!-- 답변 내용 -->
                                <div class="row py-2">
                                    <div style="width: 10%;"><span></span></div>
                                    <div style="width: 90%;" class="border-top pt-2">
                                        <span th:text="${comment.recomment.detail}"
                                              style="white-space: pre-line;">답변 내용</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Q&A 페이지네이션 -->
                    <div class="pt-2 d-flex align-items-center justify-content-center">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination">
                                <li class="page-item">
                                    <a class="page-link" href="#"
                                       th:href="@{/product/{id}(id=${product.id}, commentPage=1)}"
                                       aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item" th:each="page : ${#numbers.sequence(1,commentTotalPages, 1)}">
                                    <a class="page-link" th:text="${page}"
                                       th:href="@{/product/{id}(id=${product.id}, commentPage=${page})}" href="#">1</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#"
                                       th:href="@{/product/{id}(id=${product.id}, commentPage=${commentTotalPages})}"
                                       aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <!-- 문의 작성 모달 -->
                    <div>
                        <!-- 작성하기 버튼 -->
                        <button type="button" id="show-commentModal-btn" class="custom-btn custom-btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#commentModal"
                                th:attr="data-product-id=${product.id}"
                                sec:authorize="isAuthenticated()">
                            문의 작성
                        </button>

                        <!-- 문의 작성 모달창 -->
                        <div class="modal fade" id="commentModal" data-bs-backdrop="static" data-bs-keyboard="false"
                             tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="commentModalLabel">문의 작성</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="commentForm">
                                            <!-- productId -->
                                            <input type="hidden" name="productId" id="comment-productId">

                                            <!-- 문의 내용 -->
                                            <label for="comment-detail">문의 내용</label>
                                            <textarea name="detail" id="comment-detail" class="form-control" type="text"
                                                      rows="8" cols="30" maxlength="255"
                                                      placeholder="10글자 이상 입력해주세요."></textarea>

                                            <!-- 비밀글 여부 -->
                                            <input class="form-check-input pt-2" name="isSecret" type="checkbox"
                                                   value="true"
                                                   id="comment-isSecret">
                                            <label class="form-check-label" for="comment-isSecret">
                                                비밀글
                                            </label>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소
                                        </button>
                                        <button type="button" class="custom-btn custom-btn-primary" id="submitComment"
                                                disabled>작성완료
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div>
                        <!-- 답글 작성 모달창 -->
                        <div class="modal fade" id="recommentModal" data-bs-backdrop="static" data-bs-keyboard="false"
                             tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="recommentModalLabel">답변 작성</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="recommentForm">
                                            <!-- productId -->
                                            <input type="hidden" name="productId" id="recomment-productId">

                                            <!-- commentId -->
                                            <input type="hidden" name="commentId" id="recomment-commentId">

                                            <!-- 답글 내용 -->
                                            <label for="recomment-detail">답변 내용</label>
                                            <textarea name="detail" id="recomment-detail" class="form-control"
                                                      type="text" rows="8" cols="30" maxlength="255"
                                                      placeholder="10글자 이상 입력해주세요."></textarea>

                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소
                                        </button>
                                        <button type="button" class="custom-btn custom-btn-primary" id="submitRecomment"
                                                disabled>
                                            작성완료
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>


            </div>

        </div>
    </section>
</main>

<div th:insert="~{fragment/footer :: footer}"></div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script src="/cart/cart.js"></script>

<!-- Q&A 게시판 아코디언 -->
<script>
    // 답변 토글 기능 추가
    document.addEventListener("DOMContentLoaded", function () {
        const toggleAnswerBtns = document.querySelectorAll(".toggle-answer-btn");

        toggleAnswerBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                // 버튼과 동일한 row에서 다음 형제 row(answer-row)를 찾음
                const answerRow = btn.closest(".row").nextElementSibling;

                // 답변 영역 표시/숨김 토글
                if (answerRow.style.display === "none" || answerRow.style.display === "") {
                    answerRow.style.display = "flex"; // 답변 영역 표시
                } else {
                    answerRow.style.display = "none"; // 답변 영역 숨김
                }
            });
        });
    });
</script>

<!-- Q&A 데이터 검증 -->
<script>
    // 문의 검증
    document.addEventListener("DOMContentLoaded", function () {
        const commentInput = document.getElementById("comment-detail");
        const submitButton = document.getElementById("submitComment");

        // 코멘트 내용 검증 함수
        function isCommentValid() {
            const commentText = commentInput.value.trim();
            return commentText.length >= 10;  // 최소 10글자
        }

        commentInput.addEventListener("input", function () {
            submitButton.disabled = !isCommentValid();
        });

    });

    // 답변 검증
    document.addEventListener("DOMContentLoaded", function () {
        const recommentInput = document.getElementById("recomment-detail");
        const submitButton = document.getElementById("submitRecomment");

        // 코멘트 내용 검증 함수
        function isRecommentValid() {
            const recommentText = recommentInput.value.trim();
            return recommentText.length >= 10;  // 최소 10글자
        }

        recommentInput.addEventListener("input", function () {
            submitButton.disabled = !isRecommentValid();
        });
    });
</script>

<!-- 문의 모달 폼 데이터 제출 -->
<script>
    // 문의
    document.addEventListener('DOMContentLoaded', function () {
        // 문의 수정 버튼 클릭 시
        document.querySelectorAll('.edit-comment-btn').forEach(button => {
            button.addEventListener('click', function () {
                const commentId = this.getAttribute('data-comment-id');  // 클릭된 버튼에서 reviewId 가져오기
                const commentContent = this.getAttribute('data-comment-content');  // 문의 내용
                const commentIsSecret = this.getAttribute('data-comment-isSecret');  // 비밀글 여부
                const productId = this.getAttribute('data-product-id');  // 상품 ID

                // 수정 모드로 설정
                const isEditMode = true;
                document.getElementById('commentForm').reset();  // 폼 초기화
                document.getElementById('comment-productId').value = productId;
                document.getElementById('comment-detail').value = commentContent;
                document.getElementById('comment-isSecret').value = commentIsSecret;

                document.getElementById('submitComment').disabled = true;
                document.getElementById('submitComment').onclick = function () {
                    submitComment(commentId, isEditMode);
                };
            });
        });

        // 문의 작성하기 버튼 클릭 시
        const writeCommentButton = document.getElementById('show-commentModal-btn');
        if (writeCommentButton) {
            writeCommentButton.addEventListener('click', function () {
                // 문의 작성 폼 초기화
                document.getElementById('commentForm').reset();
                document.getElementById('comment-productId').value = this.getAttribute('data-product-id');
                document.getElementById('comment-detail').value = '';
                document.getElementById('submitComment').disabled = true;
                document.getElementById('submitComment').onclick = function () {
                    submitComment(null, false);  // 새 문의 작성 모드
                };
            });
        }
    });

    // 문의 제출 함수
    function submitComment(commentId, isEditMode) {
        const form = document.getElementById('commentForm');
        const formData = new FormData(form);
        const url = isEditMode ? '/comment/update/' + commentId : '/comment/create';

        fetch(url, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {

                    alert(isEditMode ? '문의가 성공적으로 수정되었습니다!' : '문의가 성공적으로 작성되었습니다!');
                    window.location.href = response.url;
                } else {
                    throw new Error('서버 응답 실패');
                }
            })
            .catch(error => {
                alert(isEditMode ? '문의 수정 중 오류가 발생했습니다.' : '문의 작성 중 오류가 발생했습니다.');
            });
    }

    // 삭제 버튼 리스너등록
    document.addEventListener('DOMContentLoaded', () => {
        const deleteButtons = document.querySelectorAll('.delete-comment-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', () => {
                const commentId = button.getAttribute('data-comment-id');
                confirmDeleteComment(commentId);
            });
        });
    });

    // 문의 삭제
    function confirmDeleteComment(commentId) {
        // 삭제 여부 확인
        if (confirm('정말 삭제하시겠습니까?')) {
            // 삭제 요청 보내기
            fetch(`/comment/delete/${commentId}`, {
                method: 'POST',
            })
                .then(response => {
                    if (response.ok) {
                        alert('문의가 성공적으로 삭제되었습니다.');
                        location.reload(); // 페이지 새로고침
                    } else {
                        throw new Error('문의 삭제 실패');
                    }
                })
                .catch(error => {
                    console.error('삭제 오류:', error);
                    alert('문의 삭제 중 오류가 발생했습니다.');
                });
        }
    }
</script>

<!-- 답변 모달 폼 데이터 제출 -->
<script>
    // 답변
    document.addEventListener('DOMContentLoaded', function () {
        // 답변 수정 버튼 클릭 시
        document.querySelectorAll('.edit-recomment-btn').forEach(button => {
            button.addEventListener('click', function () {
                const recommentId = this.getAttribute('data-recomment-id');  // 클릭된 버튼에서 recommentId 가져오기
                const commentId = this.getAttribute('data-comment-id');  // 클릭된 버튼에서 commentId 가져오기
                const productId = this.getAttribute('data-product-id');  // 상품 ID
                const recommentContent = this.getAttribute('data-recomment-content');  // 답변 내용

                // 수정 모드로 설정
                const isEditMode = true;
                document.getElementById('recommentForm').reset();  // 폼 초기화
                document.getElementById('recomment-productId').value = productId;
                document.getElementById('recomment-commentId').value = commentId;
                document.getElementById('recomment-detail').value = recommentContent;

                document.getElementById('submitRecomment').disabled = true;
                document.getElementById('submitRecomment').onclick = function () {
                    submitRecomment(recommentId, isEditMode);
                };
            });
        });

        // 답변 작성하기 버튼 클릭 시
        const writeRecommentButton = document.getElementById('show-recommentModal-btn');
        if (writeRecommentButton) {
            writeRecommentButton.addEventListener('click', function () {
                // 답변 작성 폼 초기화
                document.getElementById('recommentForm').reset();
                document.getElementById('recomment-productId').value = this.getAttribute('data-product-id');
                document.getElementById('recomment-commentId').value = this.getAttribute('data-comment-id');
                document.getElementById('recomment-detail').value = '';
                document.getElementById('submitRecomment').disabled = true;
                document.getElementById('submitRecomment').onclick = function () {
                    submitRecomment(null, false);  // 새 답변 작성 모드
                };
            });
        }
    });

    // 답변 제출 함수
    function submitRecomment(recommentId, isEditMode) {
        const form = document.getElementById('recommentForm');
        const formData = new FormData(form);
        const url = isEditMode ? '/recomment/update/' + recommentId : '/recomment/create';

        fetch(url, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {
                    alert(isEditMode ? '답변이 성공적으로 수정되었습니다!' : '답변이 성공적으로 작성되었습니다!');
                    window.location.href = response.url;
                } else {
                    throw new Error('서버 응답 실패');
                }
            })
            .catch(error => {
                alert(isEditMode ? '답변 수정 중 오류가 발생했습니다.' : '답변 작성 중 오류가 발생했습니다.');
            });
    }
</script>

<!-- Review 데이터 검증 -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const reviewInput = document.getElementById("review-detail");
        const submitButton = document.getElementById("submitReview");

        // 평점 선택을 체크하는 함수
        function isRatingValid() {
            const selectedScore = document.querySelector('input[name="score"]:checked');
            return selectedScore && selectedScore.value && selectedScore.value >= 1 && selectedScore.value <= 10;
        }

        // 리뷰 내용 검증 함수
        function isReviewValid() {
            const reviewText = reviewInput.value.trim();
            return reviewText.length >= 10;  // 최소 10글자
        }

        reviewInput.addEventListener("input", function () {
            if (isReviewValid() && isRatingValid()) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        });

        // 평점 선택이 바뀔 때마다 검증
        document.querySelectorAll('input[name="score"]').forEach(function (radio) {
            radio.addEventListener("change", function () {
                if (isReviewValid() && isRatingValid()) {
                    submitButton.disabled = false;
                } else {
                    submitButton.disabled = true;
                }
            });
        });
    });
</script>


<!-- Review 폼 데이터 제출 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 리뷰 수정 버튼 클릭 시
        document.querySelectorAll('.edit-review-btn').forEach(button => {
            button.addEventListener('click', function () {
                const reviewId = this.getAttribute('data-review-id');  // 클릭된 버튼에서 reviewId 가져오기
                const reviewContent = this.getAttribute('data-review-content');  // 리뷰 내용
                const reviewScore = this.getAttribute('data-review-score');  // 리뷰 평점
                const productId = this.getAttribute('data-product-id');  // 상품 ID

                // 수정 모드로 설정
                const isEditMode = true;
                document.getElementById('reviewForm').reset();  // 폼 초기화
                document.getElementById('review-productId').value = productId;
                document.getElementById('review-detail').value = reviewContent;

                // 해당 리뷰의 평점을 라디오 버튼으로 설정
                const scoreRadios = document.querySelectorAll('input[name="score"]');
                scoreRadios.forEach(radio => {
                    radio.checked = (radio.value === reviewScore);  // 리뷰의 평점에 맞게 선택
                });

                document.getElementById('submitReview').disabled = true;
                document.getElementById('submitReview').onclick = function () {
                    submitReview(reviewId, isEditMode);
                };
            });
        });

        // 리뷰 작성하기 버튼 클릭 시
        const writeReviewButton = document.getElementById('show-reviewModal-btn');
        if (writeReviewButton) {
            writeReviewButton.addEventListener('click', function () {
                // 리뷰 작성 폼 초기화
                document.getElementById('reviewForm').reset();
                document.getElementById('review-productId').value = this.getAttribute('data-product-id');
                document.getElementById('review-detail').value = '';
                document.getElementById('submitReview').disabled = true;
                document.getElementById('submitReview').onclick = function () {
                    submitReview(null, false);  // 새 리뷰 작성 모드
                };
            });
        }
    });

    // 리뷰 제출 함수
    function submitReview(reviewId, isEditMode) {
        const form = document.getElementById('reviewForm');
        const formData = new FormData(form);
        const url = isEditMode ? '/review/update/' + reviewId : '/review/create';
        // const method = isEditMode ? 'PUT' : 'POST';

        fetch(url, {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {

                    alert(isEditMode ? '리뷰가 성공적으로 수정되었습니다!' : '리뷰가 성공적으로 작성되었습니다!');
                    window.location.href = response.url;
                } else {
                    throw new Error('서버 응답 실패');
                }
            })
            .catch(error => {
                alert(isEditMode ? '리뷰 수정 중 오류가 발생했습니다.' : '리뷰 작성 중 오류가 발생했습니다.');
            });
    }

    // 리뷰 버튼 리스너등록
    document.addEventListener('DOMContentLoaded', () => {
        const deleteButtons = document.querySelectorAll('.delete-review-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', () => {
                const reviewId = button.getAttribute('data-review-id');
                confirmDeleteReview(reviewId);
            });
        });
    });

    // 리뷰 삭제
    function confirmDeleteReview(reviewId) {
        // 삭제 여부 확인
        if (confirm('정말 삭제하시겠습니까?')) {
            // 삭제 요청 보내기
            fetch(`/review/delete/${reviewId}`, {
                method: 'POST',
            })
                .then(response => {
                    if (response.ok) {
                        alert('리뷰가 성공적으로 삭제되었습니다.');
                        location.reload(); // 페이지 새로고침
                    } else {
                        throw new Error('리뷰 삭제 실패');
                    }
                })
                .catch(error => {
                    console.error('삭제 오류:', error);
                    alert('리뷰 삭제 중 오류가 발생했습니다.');
                });
        }
    }
</script>

<!-- 상품 페이지  -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 필요한 DOM 요소
        const selectElement = document.querySelector(".option-select");
        const selectedProductDiv = document.getElementById("selectedProductDiv");
        const totalPriceElement = document.getElementById("totalPrice");
        const addToCartBtn = document.getElementById("addToCartBtn");
        const basicPrice = document.getElementById("productBasicPrice").getAttribute('data-basic-price');

        // 선택된 옵션 저장
        let selectedOption = null; // 현재 선택된 옵션 정보

        // 옵션 변경 이벤트
        selectElement.addEventListener("change", function () {
            const selectedOptionElement = this.options[this.selectedIndex];
            const optionId = selectedOptionElement.value;
            const optionName = selectedOptionElement.textContent.trim();
            const optionPrice = parseInt(basicPrice) + (parseInt(selectedOptionElement.dataset.price, 10) || 0);
            const optionCount = selectedOptionElement.getAttribute('data-option-count');


            if (!optionId || optionId === "[필수] 옵션을 선택해 주세요") {
                return;
            }

            // 기존 선택된 옵션이 있으면 경고 메시지
            if (selectedOption) {
                // alert("이미 옵션이 선택되었습니다. 기존 옵션을 삭제 후 다시 선택해주세요.");
                // return;
                removeOption();
            }

            // 선택된 옵션 저장
            selectedOption = {optionId, optionName, optionPrice, quantity: 1};

            // 선택된 옵션 표시
            const optionRow = document.createElement("div");
            optionRow.className = "selected-option border-top border-bottom";
            optionRow.dataset.optionId = optionId;
            optionRow.innerHTML = `
            <div class="row align-items-center mt-2 mb-2">
                <div class="col-4">
                    <span class="fw-bold">${optionName}</span>
                </div>
                <div class="col-4 d-flex align-items-center justify-content-center">
                    <button class="btn btn-outline-secondary  mx-1 decrease-qty">-</button>
                    <input type="text" value="1" class="form-control form-control-sm text-center mx-1 quantity-input" style="width: 50px;" readonly>
                    <button class="btn btn-outline-secondary btn-sm mx-1 increase-qty">+</button>
                </div>
                <div class="col-3 text-end">
                    <span class="fw-bold option-price">${optionPrice.toLocaleString()}원</span>
                </div>
                <div class="col-1 text-end">
                    <button class="btn btn-danger btn-sm remove-option">X</button>
                </div>
            </div>
        `;
            selectedProductDiv.appendChild(optionRow);

            // 총 가격 갱신
            updateTotalPrice();

            // 수량 증가 이벤트
            optionRow.querySelector(".increase-qty").addEventListener("click", function () {
                changeQuantity(1,optionCount);
            });

            // 수량 감소 이벤트
            optionRow.querySelector(".decrease-qty").addEventListener("click", function () {
                changeQuantity(-1,optionCount);
            });

            // 옵션 삭제 이벤트
            optionRow.querySelector(".remove-option").addEventListener("click", function () {
                removeOption();
            });
        });

        // 수량 변경 함수
        function changeQuantity(delta, optionCount) {
            if (!selectedOption) return;

            const newQuantity = selectedOption.quantity + delta;

            // 최소 수량 제한
            if (newQuantity < 1) {
                alert("최소 수량은 1개입니다.");
                return;
            }

            // 최대 수량 제한
            if (delta > 0 && newQuantity > optionCount) {
                alert("최대 수량입니다.");
                return;
            }

            // 수량 업데이트
            selectedOption.quantity = newQuantity;

            // 업데이트된 수량 및 가격 반영
            const optionRow = selectedProductDiv.querySelector(`[data-option-id="${selectedOption.optionId}"]`);
            optionRow.querySelector(".quantity-input").value = selectedOption.quantity;
            const updatedPrice = selectedOption.optionPrice * selectedOption.quantity;
            optionRow.querySelector(".option-price").textContent = `${updatedPrice.toLocaleString()}원`;

            // 총 가격 갱신
            updateTotalPrice();
        }

        // 옵션 삭제 함수
        function removeOption() {
            const optionRow = selectedProductDiv.querySelector(`[data-option-id="${selectedOption.optionId}"]`);
            if (optionRow) {
                optionRow.remove();
            }
            selectedOption = null; // 선택된 옵션 초기화
            updateTotalPrice();
        }

        // 총 가격 갱신 함수
        function updateTotalPrice() {
            let totalPrice = 0;
            if (selectedOption) {
                totalPrice = selectedOption.optionPrice * selectedOption.quantity;
            }
            totalPriceElement.textContent = `${totalPrice.toLocaleString()} 원`;
        }

    });
</script>

<script>
    // 구매하기 버튼
    document.addEventListener('DOMContentLoaded', function () {
        const buyBtn = document.getElementById('buyBtn');

        buyBtn.addEventListener('click', function () {
            const productId = buyBtn.getAttribute('data-product-id');
            const productName = document.getElementById('productName').textContent;
            const productImage = document.querySelector('#product-reqImage').src;
            const basicPrice = parseInt(document.getElementById('productBasicPrice').getAttribute('data-basic-price'));
            const quantity = parseInt(document.querySelector('.quantity-input').value);
            const selectedOptionElement = document.querySelector('.option-select');
            const selectedOption = selectedOptionElement.options[selectedOptionElement.selectedIndex];
            const optionId = selectedOption.value;
            const optionName = selectedOption.text;
            const optionPrice = parseInt(selectedOption.getAttribute('data-price'));

            if (!optionId || optionId === '0') {
                alert('옵션을 선택해주세요.');
                return;
            }

            // 모든 옵션 값 가져오기 (첫 번째 옵션 제외)
            const allOptions = Array.from(selectedOptionElement.options)
                .filter(option => option.value !== "[필수] 옵션을 선택해 주세요" && option.value) // 첫 번째 옵션 제외
                .map(option => ({
                    optionId: option.value,
                    optionName: option.text,
                    optionPrice: parseInt(option.getAttribute('data-price'))
                }));


            const product = {
                productId,
                name: productName,
                basePrice: basicPrice,
                image: productImage,
                purchaseCounts: quantity,
                checked: true,
                selectedOption: {
                    optionId,
                    optionName,
                    optionPrice
                },
                options: allOptions
            };

            const curCart = getCart(); //원래 장바구니 카트
            const newCart = [];  // 비어있는 카트

            newCart.push(product);

            localStorage.setItem('productIds', JSON.stringify(newCart));
            localStorage.setItem('productIds2', JSON.stringify(curCart));
            window.location.href = `/view/payment/orders`;
        });
    });




</script>

<!--<script src="/cart/cart.js"></script>-->

</body>
</html>
